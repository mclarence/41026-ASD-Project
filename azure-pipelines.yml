trigger:
  - main
pr:
  - main

variables:
  CI: 'true'
  BASE_SHA: $(System.PullRequest.PullRequestId) # Set a default value, this will be updated later
  NX_BRANCH: $(Build.SourceBranchName)
  HEAD_SHA: $(Build.SourceVersion)

jobs:
  - job: main
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      # Set Azure DevOps CLI default settings
      - bash: |
          az devops configure --defaults organization=$(System.TeamFoundationCollectionUri) project=$(System.TeamProject)
        displayName: 'Set default Azure DevOps organization and project'

      # Get last successful commit from Azure DevOps CLI
      - bash: |
          LAST_SHA=$(az pipelines build list --branch $(Build.SourceBranch) --definition-ids $(System.DefinitionId) --result succeeded --top 1 --query "[0].triggerInfo.\"ci.sourceSha\"")
          if [ -z "$LAST_SHA" ]
          then
            LAST_SHA=$BASE_SHA
          fi
          echo "Last successful commit SHA: $LAST_SHA"
          echo "##vso[task.setvariable variable=BASE_SHA]$LAST_SHA"
        displayName: 'Get last successful commit SHA'
        env:
          AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)

      - script: npm ci

      - script: npx nx format:check --base=$BASE_SHA

      - script: npx nx affected --base=$BASE_SHA -t lint --parallel=3
      - script: npx nx affected --base=$BASE_SHA -t test --parallel=3 --configuration=ci
      - script: npx nx affected --base=$BASE_SHA -t build --parallel=3
